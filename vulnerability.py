import requests
import json

def check_vulnerabilities(package_name, version):
    url = "https://api.osv.dev/v1/query"
    headers = {"Content-Type": "application/json"}
    payload = {
        "package": {
            "name": package_name,
            "ecosystem": "PyPI"
        },
        "version": version
    }

    response = requests.post(url, headers=headers, json=payload)

    if response.status_code != 200:
        return [{"error": f"Error: {response.status_code} - {response.text}"}]

    data = response.json()
    vulns = data.get("vulns", [])

    if not vulns:
        return [{"message": f"No known vulnerabilities found for {package_name}=={version}."}]
    else:
        vulnerabilities = []
        for v in vulns:
            vulnerabilities.append({
                "id": v.get('id'),
                "summary": v.get('summary', 'N/A'),
                "affected_range": v['affected'][0].get('ranges')[0].get('events'),
                "details": v.get('details', 'N/A'),
                "more_info": v.get('references', [{}])[0].get('url', 'N/A')
            })
        return vulnerabilities  # Return the list of vulnerabilities directly
